import groovy.json.JsonOutput

/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java library project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/7.6.1/userguide/building_java_projects.html
 */

buildscript {
  repositories {
    mavenLocal()
    mavenCentral()
    maven {
      url "https://plugins.gradle.org/m2/"
    }
    maven {
      url = uri("http://packages.muyan.io/artifactory/libs-release")
      allowInsecureProtocol= true
    }
  }
  dependencies {
    classpath "gradle.plugin.com.github.harbby:gradle-serviceloader:1.1.8"
  }
}

plugins {
  // Apply the java-library plugin for API and implementation separation.
  id 'java-library'
  id 'groovy'
  id 'idea'
}
apply plugin: "com.github.harbby.gradle.serviceloader"

version "0.0.1"
group "tech.muyan.plugin"

def muyanPluginName = "DemoPlugin"
def muyanPluginVersion = project.version
def description = "Demo Plugin"
def dependsOnPlugins = [
  "PlatformAdapter": "0.0.1",
]

repositories {
  mavenLocal()
  // Use Maven Central for resolving dependencies.
  mavenCentral()
  maven {
    url = uri("http://packages.muyan.io/artifactory/libs-release")
    allowInsecureProtocol= true
  }
}

dependencies {
  // Use JUnit test framework.
  testImplementation 'junit:junit:4.13.2'

  // Use the latest Groovy version for building this library
  compileOnly 'org.codehaus.groovy:groovy-all:3.0.18'

  compileOnly 'tech.muyan:api:0.0.2'

  compileOnly 'org.slf4j:slf4j-api:1.7.32'
}

java {
  toolchain {
    languageVersion.set(JavaLanguageVersion.of(11))
  }
  withSourcesJar()
}

serviceLoader {
  serviceInterface 'tech.muyan.api.MuyanPlatformComponent', 'tech.muyan.api.DynamicDomainEntity'
}

jar {
  manifest {
    attributes(
      'Muyan-Plugin-Name': muyanPluginName,
      'Muyan-Plugin-Version': muyanPluginVersion,
    )
  }
}

String workingFolder = "$buildDir/tmp/muyan-plugin"
String targetFolder = "$buildDir/muyan-plugin"
def workingFolderFile = file(workingFolder)
def targetFolderFile = file(targetFolder)
if (workingFolderFile.exists()) {
  delete workingFolderFile
}
if (targetFolderFile.exists()) {
  delete targetFolderFile
}
mkdir workingFolder

tasks.register("generateMuyanPluginInfo") {
  group = 'Muyan Tasks'
  description = 'Generates plugin information for Muyan.'
  Map pluginInfo = [
    name: muyanPluginName,
    version: muyanPluginVersion,
    dependsOnPlugins: dependsOnPlugins,
    description: description,
  ]
  File pluginInfoFile = file("$workingFolder/PLUGIN_INFO")
  pluginInfoFile.text = JsonOutput.toJson(pluginInfo)
}

tasks.register("packageMuyanPlugin", Zip) {
  group = 'Muyan Tasks'
  description = 'Packages the Muyan plugin into a .myp archive.'
  dependsOn "jar", "build", "generateMuyanPluginInfo"
  mkdir targetFolder
  archiveName "$muyanPluginName-${muyanPluginVersion}.myp"
  destinationDir(file(targetFolder))
  from "$workingFolder/"
  include '*'
  include '*/*'
  doFirst {
    copy {
      into("$workingFolder/libs")
      from(project.configurations.runtimeClasspath, jar.archiveFile)
    }
  }
}

idea {
  module {
    file("../data/groovy").listFiles().each {
      if (it.isDirectory()) {
        sourceDirs += it
      }
    }
  }
}